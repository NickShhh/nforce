const express = require('express');
const router = express.Router();
const fetch = require('node-fetch');
const { WEBHOOK_URL } = require('../config');

router.post('/', async (req, res) => {
  try {
    const { userId, reason, details, device, fps, ping, team, geo, behavior, avatarUrl } = req.body;

    const embed = {
      title: '🚨 Possible Exploiter Detected',
      description: `Player **${userId}** was flagged by the anticheat system.`,
      color: 16711680,
      fields: [
        { name: '🧠 Behavior', value: behavior || 'N/A', inline: false },
        { name: '🖥️ Device', value: device || 'Unknown', inline: true },
        { name: '📡 Ping', value: `${ping}ms`, inline: true },
        { name: '🎮 FPS', value: `${fps}`, inline: true },
        { name: '🗺️ Location', value: geo || 'Unknown', inline: true },
        { name: '🛠️ Details', value: reason || 'No reason provided.', inline: false },
        { name: '👥 Team', value: team || 'N/A', inline: true }
      ],
      thumbnail: avatarUrl ? { url: avatarUrl } : undefined,
      timestamp: new Date().toISOString(),
      footer: { text: 'N-FORCE Anticheat System' }
    };

    const components = [
      {
        type: 1,
        components: [
          {
            type: 2,
            style: 4,
            label: 'Ban Player',
            custom_id: `ban_${userId}`
          }
        ]
      }
    ];

    await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ embeds: [embed], components })
    });

    res.json({ message: 'Exploit report sent to Discord' });
  } catch (err) {
    console.error('Error sending exploit report:', err);
    res.status(500).json({ error: 'Failed to send report' });
  }
});

module.exports = router;
